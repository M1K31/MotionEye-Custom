{% extends "base.html" %}

{% block title %}Familiar Faces{% endblock %}

{% block content %}
<div class="container">
    <h1>Familiar Faces</h1>
    <p>Manage the faces that motionEye recognizes. Upload a clear, front-facing picture of a person.</p>

    <div id="unfamiliar-face-container">
        <h2>Unfamiliar Face Log</h2>
        <p>Last unfamiliar face detected: <strong id="last-unfamiliar-face">Never</strong></p>
    </div>

    <div id="faces-list-container">
        <h2>Known Faces</h2>
        <ul id="faces-list">
            <!-- Faces will be populated by JavaScript -->
            <li class="loading">Loading...</li>
        </ul>
    </div>

    <div id="add-face-container">
        <h2>Add a New Face</h2>
        <form id="add-face-form" class="form-horizontal">
            <div class="form-group">
                <label for="face-name" class="control-label">Name</label>
                <div class="controls">
                    <input type="text" id="face-name" name="name" required>
                </div>
            </div>
            <div class="form-group">
                <label for="face-file" class="control-label">Image File</label>
                <div class="controls">
                    <input type="file" id="face-file" name="file" accept="image/jpeg, image/png" required>
                </div>
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Add Face</button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const facesList = document.getElementById('faces-list');
    const addFaceForm = document.getElementById('add-face-form');

    function loadFaces() {
        facesList.innerHTML = '<li class="loading">Loading...</li>';
        const lastUnfamiliarFaceEl = document.getElementById('last-unfamiliar-face');

        fetch('/faces')
            .then(response => response.json())
            .then(data => {
                // Handle last unfamiliar face
                if (data.last_unfamiliar_face) {
                    const d = new Date(data.last_unfamiliar_face);
                    lastUnfamiliarFaceEl.textContent = d.toLocaleString();
                } else {
                    lastUnfamiliarFaceEl.textContent = 'Never';
                }

                // Handle known faces list
                const faces = data.faces;
                facesList.innerHTML = '';
                if (faces.length === 0) {
                    facesList.innerHTML = '<li>No faces have been added yet.</li>';
                } else {
                    faces.forEach(face => {
                        const li = document.createElement('li');
                        li.textContent = face.name;
                        const deleteButton = document.createElement('button');
                        deleteButton.textContent = 'Delete';
                        deleteButton.className = 'btn btn-danger btn-xs';
                        deleteButton.onclick = () => deleteFace(face.filename);
                        li.appendChild(deleteButton);
                        facesList.appendChild(li);
                    });
                }
            });
    }

    function deleteFace(filename) {
        if (!confirm('Are you sure you want to delete this face?')) {
            return;
        }
        fetch(`/faces/${filename}`, { method: 'DELETE' })
            .then(() => {
                loadFaces(); // Refresh the list
            });
    }

    addFaceForm.addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(addFaceForm);
        fetch('/faces', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(result => {
            if (result.error) {
                alert('Error: ' + result.error);
            } else {
                addFaceForm.reset();
                loadFaces(); // Refresh the list
            }
        });
    });

    loadFaces();
});
</script>
{% endblock %}
